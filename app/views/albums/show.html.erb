<div class="max-w-3xl mx-auto p-6 bg-white rounded-lg shadow-md mt-10">
  
  <div class="border-b pb-4 mb-4">
    <h1 class="text-3xl font-bold text-gray-800"><%= @album.title %></h1>
    <p class="text-sm text-gray-500 mt-1">
      作成日: <%= @album.created_at.strftime("%Y年%m月%d日") %>
    </p>
  </div>

  <%# マップ用のデータを作成 %>
  <% 
    map_data = []
    @album_spots.each.with_index(1) do |spot, index|
      if spot.latitude.present? && spot.longitude.present? && spot.photos.present?
        map_data << {
          id: spot.id,
          name: spot.spot_name,
          lat: spot.latitude,
          lng: spot.longitude,
          image_url: url_for(spot.photos.first.image),
          number: index.to_s
        }
      end
    end
  %>

  <% if map_data.present? %>
    <div class="mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-2">旅のルート</h2>
      
      <%# Stimulusコントローラーを呼び出す %>
      <div style="height: 400px; width: 100%; border-radius: 0.5rem;"
          data-controller="map"
          data-map-api-key-value="<%= ENV['GOOGLE_MAPS_API_KEY'] %>"
          data-map-spots-value="<%= map_data.to_json %>">
      </div>
    </div>
  <% end %>
  <%# ----------------------------- %>


  <div class="mb-6">
    <%# アルバムにスポットがあるか %>
    <% if @album_spots.present? %>
        <%# 画像の一覧を表示 %>
        <% @album_spots.each do |spot| %>

          <div class="spot">
            <h3> <%= spot.spot_name %> </h3>

            <%# 緯度と経度がないときだけ表示する %>
            <% if spot.latitude.blank? && spot.longitude.blank? %>
              <p> 位置情報がありません </p>
            <% end %>

            <% spot.photos.each do |photo| %>
              
              <%= image_tag photo.image, width: 200 %>
              
              <p> <%= photo.taken_at %> </p>

            <% end %>
          </div>

        <% end %>
    <%# 画像がないときの処理 %>
    <% else %>
        <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500">
            No Image
        </div>
    <% end %>
  </div>

  <div class="text-gray-700 leading-relaxed mb-8 min-h-[100px]">
    <%= simple_format(@album.description) %>
  </div>

  <div class="flex items-center justify-between border-t pt-6">
    <%= link_to "一覧に戻る", albums_path, class: "text-gray-600 hover:text-gray-900 underline" %>

    <% if current_user.id == @album.user_id %>
        <div class="space-x-2">
            <%= link_to "編集する", edit_album_path(@album), class: "bg-[#ff8737] text-white px-4 py-2 rounded hover:opacity-80" %>
            <%= link_to "削除する", album_path(@album), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, class: "bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300" %>
        </div>
    <% end %>
  </div>

</div>